name: Docker
on:
    push:
        branches: ['master', 'development']
jobs:
    lint:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [16.x]
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-node@v2-beta
              with:
                  node-version: ${{ matrix.node-version }}
            - name: npm install
              run: npm ci
            - name: Run linter
              run: npm run lint

    unit-tests:
        runs-on: ubuntu-latest
        needs: [lint]
        strategy:
            matrix:
                node-version: [16.x]
        steps:
            - uses: actions/checkout@v2
            - name: Use NodeJS ${{ matrix.node-version }}
            - uses: actions/setup-node@v2-beta
              with:
                  node-version: ${{ matrix.node-version }}
            - name: npm install
              run: npm ci
            - name: Run unit tests
              run: npm run test

    e2e-test:
        runs-on: ubuntu-latest
        needs: [unit-tests]
        strategy:
            matrix:
                node-version: [16.x]
        steps:
            - uses: actions/checkout@v1
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}
            - name: Login into github docker registry
              run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login docker.pkg.github.com --username ${{ secrets.DOCKER_USERNAME }} --password-stdin
            - name: Start Docker-Compose
              run: docker-compose up -d
            - name: npm install
              run: npm ci
            - name: Run e2e tests
              run: npm run test:e2e
            - name: Stop Docker-Compose
              run: docker-compose down

    # build:
    #     runs-on: ubuntu-latest
    #     steps:
    #         - uses: actions/checkout@master
    #         - name: Publish to registry
    #           uses: elgohr/Publish-Docker-Github-Action@master
    #           with:
    #               registry: docker.pkg.github.com
    #               name: docker.pkg.github.com/wavilikhin/nest-api/nest-api
    #               username: ${{ secrets.DOCKER_USERNAME }}
    #               password: ${{ secrets.DOCKER_PASSWORD }}
    #               tags: 'develop'
